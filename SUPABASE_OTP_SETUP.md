# Supabase OTP Email Verification Setup

## Overview

This app uses **Supabase's built-in OTP (One-Time Password) system** for email verification during sign-up. This is a simple, secure, and reliable method that doesn't require external email services like Resend.

## How It Works

### 1. **Email Verification Flow**

```
User enters email
    ‚Üì
App calls Supabase signInWithOtp()
    ‚Üì
Supabase generates 6-digit code
    ‚Üì
Supabase sends email with your custom template
    ‚Üì
User enters code in app
    ‚Üì
App verifies with Supabase verifyOTP()
    ‚Üì
User is authenticated ‚úÖ
    ‚Üì
User sets permanent password
    ‚Üì
Account fully created üéâ
```

### 2. **Key Features**

‚úÖ **Secure 6-digit codes** - Generated by Supabase, cryptographically secure  
‚úÖ **Custom email template** - Your HTML template with `{{ .Token }}`  
‚úÖ **Automatic expiration** - Codes expire after 1 hour (Supabase default)  
‚úÖ **Rate limiting** - Built-in protection against abuse (60 seconds between requests)  
‚úÖ **No external services** - Everything handled by Supabase  
‚úÖ **No database table needed** - Supabase manages OTP storage internally  

## Supabase Dashboard Configuration

### Step 1: Configure Email Template

1. Go to your Supabase Dashboard: https://wlpuqichfpxrwchzrdzz.supabase.co
2. Navigate to **Authentication** ‚Üí **Email Templates**
3. Select **"Magic Link"** template (this is used for OTP emails)
4. Replace the template with your custom HTML:

```html
<h2>One-Time Login Code</h2>
<p>Please enter this code to log in:</p>
<h1>{{ .Token }}</h1>
<p>The code is valid for a short period.</p>
```

5. Click **Save**

> **Note:** The `{{ .Token }}` variable will be replaced with the 6-digit OTP code.

### Step 2: Email Settings (Optional)

#### Using Supabase's Default Email Service (Recommended for Development)

- ‚úÖ **Already configured** - Supabase provides a default email service
- ‚úÖ **No setup needed** - Works immediately
- ‚ö†Ô∏è **Rate limits apply** - 3 emails per hour per email address in free tier
- üìß **From address:** noreply@mail.app.supabase.io

#### Using Custom SMTP (Recommended for Production)

For production apps, configure custom SMTP to:
- Remove rate limits
- Use your own domain (e.g., verify@yourdomain.com)
- Better deliverability

1. Go to **Settings** ‚Üí **Project Settings** ‚Üí **SMTP Settings**
2. Enter your SMTP details:
   - **Host:** smtp.gmail.com (or your provider)
   - **Port:** 587
   - **Username:** your-email@gmail.com
   - **Password:** your-app-password
   - **Sender email:** verify@yourdomain.com
   - **Sender name:** Your App Name

Popular SMTP providers:
- **Gmail** (free, 500 emails/day)
- **SendGrid** (free, 100 emails/day)
- **AWS SES** (pay as you go)
- **Mailgun** (free, 5000 emails/month)

### Step 3: Disable Email Confirmation (CRITICAL!)

To prevent Supabase from sending magic links instead of OTP codes:

1. Go to **Authentication** ‚Üí **Providers** ‚Üí **Email**
2. **Turn OFF** the "Confirm email" toggle
3. Click **Save**

This ensures users get the 6-digit code instead of a magic link.

## Code Implementation

### Email Verification Service

The `EmailVerificationService` handles all OTP operations:

```dart
// Send OTP to email
await EmailVerificationService.instance.sendVerificationCode(email);

// Verify OTP code
bool isValid = await EmailVerificationService.instance.verifyCode(email, code);

// Resend OTP
await EmailVerificationService.instance.resendVerificationCode(email);
```

### Under the Hood

**Sending OTP:**
```dart
await supabase.auth.signInWithOtp(
  email: email,
  emailRedirectTo: null, // No redirect for OTP
);
```

**Verifying OTP:**
```dart
final response = await supabase.auth.verifyOTP(
  type: OtpType.email,
  token: code,
  email: email,
);
```

**Setting Password:**
```dart
// User is already authenticated after OTP verification
await supabase.auth.updateUser(
  UserAttributes(password: password),
);
```

## User Experience Flow

### 1. Sign Up Process

```dart
// screens/email_input_screen.dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => EmailVerificationScreen(email: email),
  ),
);
```

### 2. OTP Verification

```dart
// screens/email_verification_screen.dart
// User enters 6-digit code
// Code is verified with Supabase
// User is automatically signed in on success
```

### 3. Password Setup

```dart
// screens/create_password_screen.dart
// User is already authenticated
// Just update their password
await SupabaseAuthService.instance.updatePassword(password);
```

## Security Features

### 1. **Secure Code Generation**
- Supabase generates cryptographically secure codes
- 6 digits = 1 million possible combinations

### 2. **Automatic Expiration**
- Codes expire after 1 hour
- Old codes are automatically invalidated

### 3. **Rate Limiting**
- Maximum 1 OTP request per 60 seconds per email
- Prevents spam and abuse

### 4. **Single Use**
- Each code can only be used once
- Verified codes are immediately invalidated

### 5. **No Code Storage**
- Codes are never stored in your database
- Managed entirely by Supabase Auth

## Testing

### Development Testing

1. Run the app: `flutter run`
2. Enter a real email address you have access to
3. Check your inbox for the OTP code
4. Enter the 6-digit code in the app
5. Set your password
6. You're signed in! ‚úÖ

### Common Issues

#### Issue: Not receiving emails

**Solutions:**
- ‚úÖ Check spam/junk folder
- ‚úÖ Verify email address is correct
- ‚úÖ Check Supabase rate limits (3 emails/hour in free tier)
- ‚úÖ Wait 60 seconds between requests
- ‚úÖ Check Supabase Dashboard ‚Üí Logs for email delivery status

#### Issue: "Invalid or expired code"

**Solutions:**
- ‚úÖ Code expires after 1 hour - request a new one
- ‚úÖ Code can only be used once - request a new one if you already tried
- ‚úÖ Make sure you entered all 6 digits correctly
- ‚úÖ Check for typos (0 vs O, 1 vs l)

#### Issue: Still receiving magic link

**Solutions:**
- ‚úÖ Disable "Confirm email" in Supabase Dashboard ‚Üí Authentication ‚Üí Providers ‚Üí Email
- ‚úÖ Clear your browser cache
- ‚úÖ Request a new code after disabling

## Database Tables (Not Needed!)

‚ùå **You do NOT need the `verification_codes` table** if using Supabase OTP  
‚úÖ Supabase manages OTP storage internally  
‚úÖ No custom database tables required  
‚úÖ Simpler architecture, less maintenance  

If you previously created `verification_codes` table, you can safely delete it:

```sql
-- Optional: Remove old verification_codes table
DROP TABLE IF EXISTS verification_codes;
```

## Production Checklist

### Before Launching

- [ ] Configure custom SMTP in Supabase Dashboard
- [ ] Set up custom domain for email sender (verify@yourdomain.com)
- [ ] Test email deliverability with multiple email providers (Gmail, Outlook, etc.)
- [ ] Verify SPF, DKIM, and DMARC records for your domain
- [ ] Monitor email delivery in Supabase Dashboard ‚Üí Logs
- [ ] Test rate limiting behavior (60-second cooldown)
- [ ] Verify OTP expiration (1 hour default)
- [ ] Ensure "Confirm email" is disabled in Authentication settings
- [ ] Test complete sign-up flow end-to-end
- [ ] Add error handling for network issues
- [ ] Set up monitoring for authentication failures

### Email Template Improvements

For production, enhance your email template:

```html
<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .code {
            font-size: 36px;
            font-weight: bold;
            color: #2D9CDB;
            letter-spacing: 8px;
            text-align: center;
            padding: 20px;
            background: #F0F3FB;
            border-radius: 10px;
            margin: 20px 0;
        }
        .footer {
            font-size: 12px;
            color: #666;
            margin-top: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Welcome to Mindful Chat!</h2>
        <p>Please enter this verification code to complete your sign-up:</p>
        <div class="code">{{ .Token }}</div>
        <p>This code will expire in 1 hour.</p>
        <p>If you didn't request this code, please ignore this email.</p>
        <div class="footer">
            <p>¬© 2025 Mindful Chat. All rights reserved.</p>
        </div>
    </div>
</body>
</html>
```

## Monitoring

### Supabase Dashboard Logs

Monitor OTP activity:

1. Go to **Logs** ‚Üí **Auth Logs**
2. Filter by event type: `user.signin.otp`
3. Check for:
   - ‚úÖ Successful OTP sends
   - ‚ö†Ô∏è Rate limit errors
   - ‚ùå Delivery failures

### Common Log Messages

```
‚úÖ "OTP sent" - Email delivered successfully
‚ö†Ô∏è "Rate limit exceeded" - User requested OTP too quickly
‚ùå "SMTP error" - Email delivery failed (check SMTP settings)
```

## Advantages Over Custom Solutions

| Feature | Supabase OTP | Custom (Resend/SendGrid) |
|---------|-------------|--------------------------|
| **Setup Time** | 5 minutes | 30+ minutes |
| **Cost** | Free tier included | Requires API key, billing |
| **Maintenance** | None | Manage API keys, rate limits |
| **Security** | Built-in, audited | DIY implementation |
| **Rate Limiting** | Automatic | Must implement |
| **Code Storage** | Handled by Supabase | Requires database table |
| **Expiration** | Automatic | Must implement |
| **Email Sending** | Built-in or custom SMTP | Requires integration |

## Support

### Documentation
- [Supabase Auth OTP](https://supabase.com/docs/guides/auth/auth-otp)
- [Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [SMTP Configuration](https://supabase.com/docs/guides/auth/auth-smtp)

### Need Help?
- Check Supabase Discord: https://discord.supabase.com
- Supabase Support: https://supabase.com/support
- GitHub Issues: https://github.com/supabase/supabase/issues

---

**Last Updated:** October 1, 2025  
**Supabase Project:** https://wlpuqichfpxrwchzrdzz.supabase.co
